<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vodojem P√°vice</title>

<style>
  :root{
    --max-level-cm:243;
    --max-volume:44262;
    --accent:#0078d7;
    --water-grad-start: rgba(200,215,220,0.95);
    --water-grad-mid: rgba(200,215,220,0.75);
    --water-grad-end: rgba(200,215,220,0.60);
  }
  html,body{height:100%;margin:0}
  body{
    font-family:"Segoe UI",Tahoma,Arial,sans-serif;
    background:#f6f8fa;color:#222;
    display:flex;justify-content:center;padding:14px;
  }
  .container{width:100%;max-width:900px}

  header{
    display:flex;align-items:center;gap:12px;
    background:#fff;padding:14px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);margin-bottom:14px;
  }
  .signal-icon{
    width:82px;height:82px;border-radius:50%;
    background:var(--accent);color:#fff;display:flex;
    align-items:center;justify-content:center;
    font-size:34px;box-shadow:0 0 12px rgba(0,120,215,0.6);
  }
  header h1{margin:0;font-size:1.4rem}
  .signal-strength{font-size:0.92rem;color:#666}

  .svg-wrap{
    background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.05);
    margin-bottom:14px;text-align:center;
  }
  .svg-title{font-weight:700;font-size:1.1rem;margin-bottom:6px}
  .svg-sub{color:#444;margin-bottom:8px}

  .card{background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.05);margin-bottom:12px}
  .title-row{display:flex;align-items:center;gap:8px;
    color:var(--accent);font-weight:700;margin-bottom:8px}
  .value{font-size:2rem;font-weight:800}
  .unit{color:#666;font-size:0.95rem}
  .small{font-size:0.9rem;color:#666}

  .progress-bar{width:100%;height:12px;background:#eee;
    border-radius:8px;overflow:hidden;margin-top:8px}
  .progress-fill{height:100%;width:0;
    background:linear-gradient(90deg,#00c853,#00aaff);
    transition:width .6s ease;border-radius:8px}

  #lastUpdate{text-align:center;color:#444;margin:12px 0;font-style:italic}

  .charts{margin-top:8px;background:#fff;padding:12px;
    border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.05)}
  canvas{width:100% !important;height:420px !important}
</style>
</head>

<body>
<div class="container">

<header>
  <div class="signal-icon">üì°</div>
  <div style="flex:1">
    <h1>Vodojem P√°vice</h1>
    <div class="signal-strength">S√≠la sign√°lu:
      <span id="signalStrength">‚Äì</span></div>
  </div>
</header>

<div class="svg-wrap">
  <div class="svg-title">Aktu√°ln√≠ zaplnƒõn√≠</div>
  <div class="svg-sub" id="svgSubtitle">‚Äî l</div>

<svg viewBox="0 0 500 400" width="340" height="260">
<defs>
<clipPath id="tankClip">
<path d="M 30,380 L 470,380
C 460,260 430,140 350,50
L 150,50
C 70,140 40,260 30,380 Z"/>
</clipPath>
</defs>

<path d="M 30,380 L 470,380
C 460,260 430,140 350,50
L 150,50
C 70,140 40,260 30,380 Z"
fill="#f7f9fb" stroke="#cfcfcf"/>

<g clip-path="url(#tankClip)">
  <rect id="waterRect" x="0" y="380" width="500" height="0"
        fill="#2a8be8"/>
</g>

<text id="svgLiters" x="250" y="170"
fill="#fff" font-size="30" font-weight="800"
text-anchor="middle">‚Äî l</text>

<text id="svgPercent" x="250" y="205"
fill="#000" font-size="26" font-weight="900"
text-anchor="middle">‚Äî %</text>
</svg>
</div>

<div class="card">
  <div class="title-row">üíß Hladina</div>
  <div><span class="value" id="levelValue">‚Äì</span>
       <span class="unit">cm</span></div>
  <div class="progress-bar">
    <div id="progressFill" class="progress-fill"></div>
  </div>
  <div class="small">max 243 cm</div>
</div>

<div class="card">
  <div class="title-row">üö∞ Pr≈Øtok</div>
  <div><span class="value" id="flowValue">‚Äì</span>
       <span class="unit">L/min</span></div>
</div>

<div id="lastUpdate">Aktualizov√°no: ‚Äì</div>

<div class="charts"><canvas id="levelChart"></canvas></div>
<div class="charts"><canvas id="flowChart"></canvas></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===== OBJEM ‚Äì BEZE ZMƒöNY =====
function getLiters(height_cm){
  const L = 5.9;
  const slope = 0.15;
  const maxH = 2.45;
  const profile = [
    [0.00, 0.00],
    [4.40, 0.00],
    [3.12, 2.45],
    [1.28, 2.45]
  ];
  let h0 = Number(height_cm)/100;
  if(isNaN(h0) || h0<=0) return 0;
  if(h0>maxH) h0=maxH;
  const h1 = Math.max(0, h0 - slope);

  function polygonArea(p){
    let a=0;
    for(let i=0;i<p.length;i++){
      const j=(i+1)%p.length;
      a += p[i][0]*p[j][1] - p[j][0]*p[i][1];
    }
    return Math.abs(a)/2;
  }
  function clip(p,h){
    const out=[];
    for(let i=0;i<p.length;i++){
      const A=p[i], B=p[(i+1)%p.length];
      const Ain=A[1]<=h, Bin=B[1]<=h;
      if(Ain) out.push([A[0],A[1]]);
      if(Ain ^ Bin){
        const t=(h-A[1])/(B[1]-A[1]);
        out.push([A[0]+t*(B[0]-A[0]), h]);
      }
    }
    return out;
  }
  function areaAt(d){
    if(d<=0) return 0;
    const c=clip(profile,d);
    return c.length<3 ? 0 : polygonArea(c);
  }
  function integrate(d0,d1){
    let steps=300; if(steps%2) steps++;
    const dx=L/steps;
    let sum=0;
    for(let i=0;i<=steps;i++){
      const t=i/steps;
      const d=d0+(d1-d0)*t;
      const A=areaAt(d);
      const k=(i===0||i===steps)?1:(i%2?4:2);
      sum+=k*A;
    }
    return sum*dx/3;
  }
  return integrate(h0,h1)*1000;
}

function fmt(n){ return Number(n).toLocaleString('cs-CZ'); }

const CHANNEL_URL =
'https://api.thingspeak.com/channels/1214142/feeds.json?results=40&api_key=SGHZ5KIDVYK3BG1M';
const MAX_VOLUME = 44262;
const MAX_LEVEL_CM = 243;

let levelChart, flowChart, lastUpdateTime=null;

async function fetchData(){
  const r = await fetch(CHANNEL_URL);
  const j = await r.json();
  const feeds = j.feeds;
  if(!feeds.length) return;

  const latest = feeds.at(-1);
  lastUpdateTime = new Date(latest.created_at);

  const level = parseFloat(latest.field2);
  const flow  = parseFloat(latest.field3);

  document.getElementById('signalStrength').textContent =
    latest.field1 || "‚Äì";
  document.getElementById('levelValue').textContent =
    isNaN(level)?"‚Äì":fmt(level.toFixed(1));
  document.getElementById('flowValue').textContent =
    isNaN(flow)?"‚Äì":fmt(flow.toFixed(2));

  const volume = getLiters(level);
  let percent = (volume / MAX_VOLUME) * 100;
  if(percent>100) percent=100;

  document.getElementById('svgLiters').textContent =
    fmt(Math.round(volume))+' l';
  document.getElementById('svgPercent').textContent =
    Math.round(percent)+' %';
  document.getElementById('svgSubtitle').textContent =
    fmt(Math.round(volume))+' l';

  // ‚úÖ JEDIN√Å ZMƒöNA ‚Äì GRAFIKA PODLE OBJEMU
  const SVG_BOTTOM = 380;
  const SVG_TOP = 50;
  const SVG_HEIGHT = SVG_BOTTOM - SVG_TOP;
  const waterH = (percent/100)*SVG_HEIGHT;

  const waterRect=document.getElementById('waterRect');
  waterRect.setAttribute('y', SVG_BOTTOM-waterH);
  waterRect.setAttribute('height', waterH);

  const pct=(level/MAX_LEVEL_CM)*100;
  document.getElementById('progressFill').style.width=pct+'%';

  document.getElementById('lastUpdate').innerHTML =
    'Aktualizov√°no p≈ôed <b>' +
    Math.floor((Date.now()-lastUpdateTime)/60000) +
    '</b> minutami';

  // ===== GRAFY ‚Äì FUNKƒåN√ç (P≈ÆVODN√ç LOGIKA) =====
  const labels=feeds.map(x=>new Date(x.created_at).toLocaleString());
  const levelData=feeds.map(x=>parseFloat(x.field2)||0);
  const flowData=feeds.map(x=>parseFloat(x.field3)||0);

  const lvlCtx=document.getElementById('levelChart').getContext('2d');
  if(!levelChart){
    levelChart=new Chart(lvlCtx,{
      type:'line',
      data:{labels,datasets:[{
        label:'Hladina (cm)',
        data:levelData,
        borderColor:'#0078d7',
        backgroundColor:'rgba(0,120,215,0.08)',
        fill:true,pointRadius:0}]},
      options:{maintainAspectRatio:false}
    });
  }else{
    levelChart.data.labels=labels;
    levelChart.data.datasets[0].data=levelData;
    levelChart.update();
  }

  const flwCtx=document.getElementById('flowChart').getContext('2d');
  if(!flowChart){
    flowChart=new Chart(flwCtx,{
      type:'line',
      data:{labels,datasets:[{
        label:'Pr≈Øtok (L/min)',
        data:flowData,
        borderColor:'#16a34a',
        backgroundColor:'rgba(34,139,34,0.08)',
        fill:true,pointRadius:0}]},
      options:{maintainAspectRatio:false}
    });
  }else{
    flowChart.data.labels=labels;
    flowChart.data.datasets[0].data=flowData;
    flowChart.update();
  }
}

fetchData();
setInterval(fetchData,30000);
</script>
</body>
</html>






