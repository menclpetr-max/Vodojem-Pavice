<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vodojem P√°vice</title>

<style>
  :root{
    --accent:#0078d7;
  }
  html,body{height:100%;margin:0}
  body{
    font-family:"Segoe UI",Tahoma,Arial,sans-serif;
    background:#f6f8fa;color:#222;
    display:flex;justify-content:center;padding:14px;
  }
  .container{width:100%;max-width:900px}

  header{
    display:flex;align-items:center;gap:12px;
    background:#fff;padding:14px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.06);margin-bottom:14px;
  }
  .signal-icon{
    width:82px;height:82px;border-radius:50%;
    background:var(--accent);color:#fff;
    display:flex;align-items:center;justify-content:center;
    font-size:34px;
  }

  .svg-wrap{
    background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.05);
    text-align:center;margin-bottom:14px;
  }

  .svg-title{font-weight:700;font-size:1.1rem}
  .svg-sub{font-weight:900;font-size:1.2rem;margin:6px 0}

  .card{
    background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.05);margin-bottom:12px
  }

  .title-row{font-weight:700;color:var(--accent);margin-bottom:6px}
  .value{font-size:2rem;font-weight:800}
  .unit{color:#666}

  .progress-bar{
    width:100%;height:12px;background:#eee;border-radius:8px;overflow:hidden
  }
  .progress-fill{
    height:100%;background:linear-gradient(90deg,#22c55e,#16a34a)
  }

  .charts{
    background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 14px rgba(0,0,0,0.05);margin-bottom:14px
  }
  canvas{width:100%!important;height:360px!important}

  #lastUpdate{
    text-align:center;color:#444;font-style:italic;margin:10px 0
  }
</style>
</head>

<body>
<div class="container">

<header>
  <div class="signal-icon">üì°</div>
  <div>
    <h2 style="margin:0">Vodojem P√°vice</h2>
    <div>S√≠la sign√°lu: <span id="signalStrength">‚Äì</span></div>
  </div>
</header>

<div class="svg-wrap">
  <div class="svg-title">Aktu√°ln√≠ zaplnƒõn√≠</div>
  <div class="svg-sub" id="svgSubtitle">‚Äì l</div>

<svg viewBox="0 0 500 400" width="340" height="260">
  <defs>
    <clipPath id="tankClip">
      <path d="M30,380 L470,380 C460,260 430,140 350,50 L150,50 C70,140 40,260 30,380 Z"/>
    </clipPath>
  </defs>

  <path d="M30,380 L470,380 C460,260 430,140 350,50 L150,50 C70,140 40,260 30,380 Z"
        fill="#f7f9fb" stroke="#bbb" stroke-width="2"/>

  <g clip-path="url(#tankClip)">
    <rect id="waterRect" x="0" y="380" width="500" height="0" fill="#2a8be8"/>
    <g id="wave">
      <path d="M0,0 C60,8 120,-8 180,0 C240,8 300,-8 360,0 C420,8 480,-8 540,0 L540,20 L0,20 Z"
            fill="rgba(255,255,255,0.35)"/>
    </g>
  </g>

  <text id="svgPercent" x="250" y="210"
        style="font-size:26px;font-weight:900;text-anchor:middle">‚Äì %</text>
</svg>
</div>

<div class="card">
  <div class="title-row">üíß Hladina</div>
  <div><span class="value" id="levelValue">‚Äì</span> <span class="unit">cm</span></div>
  <div class="progress-bar">
    <div id="progressFill" class="progress-fill"></div>
  </div>
</div>

<div class="card">
  <div class="title-row">üö∞ Pr≈Øtok</div>
  <div><span class="value" id="flowValue">‚Äì</span> <span class="unit">L/min</span></div>
</div>

<div id="lastUpdate">Aktualizov√°no: ‚Äì</div>

<div class="charts"><canvas id="levelChart"></canvas></div>
<div class="charts"><canvas id="flowChart"></canvas></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// =================== KONSTANTY ===================
const MAX_LEVEL_CM = 243;
const MAX_VOLUME = 44262;

// üîß JEN GRAFIKA SVG ‚Äì schematick√© meze
const WATER_TOP = 50;
const WATER_BOTTOM = 380;

// =================== OBJEM (STEJN√â JAKO P≈òEDT√çM) ===================
function getLiters(h_cm){
  let h = h_cm / MAX_LEVEL_CM;
  return Math.max(0, Math.min(1, h)) * MAX_VOLUME;
}

// =================== API ===================
const CHANNEL_URL =
'https://api.thingspeak.com/channels/1214142/feeds.json?results=40&api_key=SGHZ5KIDVYK3BG1M';

let levelChart, flowChart, lastUpdateTime=null;

async function fetchData(){
  const r = await fetch(CHANNEL_URL);
  const j = await r.json();
  const feeds = j.feeds;
  if(!feeds.length) return;

  const f = feeds[feeds.length-1];
  lastUpdateTime = new Date(f.created_at);

  const level = parseFloat(f.field2);
  const flow  = parseFloat(f.field3);

  const volume = getLiters(level);
  const percent = volume / MAX_VOLUME * 100;

  document.getElementById('signalStrength').textContent = f.field1 ?? '‚Äì';
  document.getElementById('levelValue').textContent = level.toFixed(1);
  document.getElementById('flowValue').textContent = flow.toFixed(2);
  document.getElementById('svgSubtitle').textContent = Math.round(volume) + ' l';
  document.getElementById('svgPercent').textContent = Math.round(percent) + ' %';
  document.getElementById('progressFill').style.width = percent + '%';

  // üîß OPRAVA GRAFIKY ‚Äì PODLE CM (REALITA)
  const ratio = Math.max(0, Math.min(1, level / MAX_LEVEL_CM));
  const waterHeight = (WATER_BOTTOM - WATER_TOP) * ratio;
  const waterY = WATER_BOTTOM - waterHeight;

  document.getElementById('waterRect')
    .setAttribute('y', waterY);
  document.getElementById('waterRect')
    .setAttribute('height', waterHeight);

  document.getElementById('wave')
    .setAttribute('transform', `translate(0,${waterY-10})`);

  // ======= GRAFY (BEZE ZMƒöNY) =======
  const labels = feeds.map(x=>new Date(x.created_at).toLocaleString());
  const levelData = feeds.map(x=>parseFloat(x.field2)||0);
  const flowData  = feeds.map(x=>parseFloat(x.field3)||0);

  if(!levelChart){
    levelChart = new Chart(levelChartEl.getContext('2d'),{
      type:'line',
      data:{labels,datasets:[{data:levelData,label:'Hladina (cm)',borderColor:'#0078d7',fill:true}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
    flowChart = new Chart(flowChartEl.getContext('2d'),{
      type:'line',
      data:{labels,datasets:[{data:flowData,label:'Pr≈Øtok (L/min)',borderColor:'#16a34a',fill:true}]},
      options:{responsive:true,maintainAspectRatio:false}
    });
  } else {
    levelChart.data.labels = labels;
    levelChart.data.datasets[0].data = levelData;
    levelChart.update();
    flowChart.data.labels = labels;
    flowChart.data.datasets[0].data = flowData;
    flowChart.update();
  }

  updateLastUpdate();
}

const levelChartEl = document.getElementById('levelChart');
const flowChartEl  = document.getElementById('flowChart');

function updateLastUpdate(){
  if(!lastUpdateTime) return;
  const diff = Math.floor((Date.now()-lastUpdateTime)/60000);
  document.getElementById('lastUpdate').innerHTML =
    diff===0 ? 'Aktualizov√°no pr√°vƒõ teƒè' : `Aktualizov√°no p≈ôed <b>${diff}</b> minutami`;
}

fetchData();
setInterval(fetchData,30000);
setInterval(updateLastUpdate,10000);
</script>

</body>
</html>




