<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vodojem P√°vice</title>

<style>
  :root{
    --max-level: 243;
  }
  body{
    font-family:"Segoe UI",Tahoma,Arial,sans-serif;
    background:#f6f8fa;
    color:#222;
    margin:0;
    padding:18px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .container{
    width:100%;
    max-width:980px;
  }

  header{
    display:flex;
    gap:18px;
    align-items:center;
    background:#fff;
    padding:18px 20px;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    margin-bottom:18px;
  }
  .signal-icon{
    width:82px;height:82px;border-radius:50%;
    background:#0078d7;color:#fff;display:flex;align-items:center;justify-content:center;
    font-size:34px;box-shadow:0 0 12px #0078d7aa;
  }
  header h1{margin:0;font-size:1.6rem}
  .signal-strength{color:#555;font-size:0.95rem}

  /* Table-like blocks */
  .cards{
    display:flex;
    gap:20px;
    width:100%;
    margin-bottom:12px;
  }
  .card{
    flex:1;
    background:#fff;
    border-radius:14px;
    padding:16px;
    text-align:center;
    box-shadow:0 6px 18px rgba(0,0,0,0.05);
  }
  .title-row{display:flex;gap:8px;align-items:center;justify-content:center;color:#0078d7;font-weight:700;margin-bottom:8px}
  .value{font-size:2.2rem;font-weight:800;margin:6px 0}
  .unit{color:#666;font-weight:600}
  .max-info{font-size:0.88rem;color:#888;margin-top:6px}

  /* progress bar */
  .progress-bar{
    width:85%;
    height:14px;
    background:#eee;
    border-radius:10px;
    margin:10px auto 0;
    overflow:hidden;
    box-shadow:inset 0 1px 3px rgba(0,0,0,0.06);
  }
  .progress-fill{
    height:100%; width:0%;
    border-radius:10px;
    transition:width .7s ease, background .4s ease;
    background:linear-gradient(90deg,#00c853,#00aaff);
  }

  /* last update - centered */
  #lastUpdate{
    text-align:center;
    font-style:italic;
    color:#555;
    margin:14px 0 18px;
    font-size:0.98rem;
    transition: color .3s ease, font-weight .2s;
  }
  #lastUpdate.stale{ color:#d93025; font-weight:700; }

  /* make the minute number pop when stale */
  #lastUpdate .mins { font-weight:800; }

  /* charts */
  .charts{
    display:flex;
    flex-direction:column;
    gap:18px;
    width:100%;
    margin-bottom:28px;
  }
  canvas{
    background:#fff;
    border-radius:14px;
    box-shadow:0 8px 20px rgba(0,0,0,0.06);
    width:100% !important;
    height:420px !important; /* zvƒõt≈°en√° v√Ω≈°ka graf≈Ø */
  }

  /* responsive */
  @media (max-width:720px){
    .cards{ flex-direction:column; }
    .progress-bar{ width:92% }
    canvas{ height:360px !important }
  }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">

    <header>
      <div class="signal-icon" title="S√≠la sign√°lu">üì°</div>
      <div>
        <h1>Vodojem P√°vice</h1>
        <div class="signal-strength">S√≠la sign√°lu: <span id="signalStrength">‚Äì</span></div>
      </div>
    </header>

    <div class="cards">
      <div class="card" id="card-level">
        <div class="title-row"><span style="font-size:22px">üíß</span><span>Hladina</span></div>
        <div class="value" id="levelValue">‚Äì</div>
        <div class="unit">cm</div>
        <div class="max-info">max 243 cm</div>
        <div class="progress-bar" aria-hidden="true"><div id="progressFill" class="progress-fill"></div></div>
      </div>

      <div class="card" id="card-flow">
        <div class="title-row"><span style="font-size:22px">üö∞</span><span>Pr≈Øtok</span></div>
        <div class="value" id="flowValue">‚Äì</div>
        <div class="unit">L/min</div>
      </div>
    </div>

    <!-- last update (centrum) -->
    <div id="lastUpdate">Aktualizov√°no: <span class="mins">‚Äì</span></div>

    <div class="charts">
      <canvas id="levelChart" aria-label="Graf hladiny" role="img"></canvas>
      <canvas id="flowChart" aria-label="Graf pr≈Øtoku" role="img"></canvas>
    </div>
  </div>

<script>
/* konfigurace */
const CHANNEL_URL = 'https://api.thingspeak.com/channels/1214142/feeds.json?results=20&api_key=SGHZ5KIDVYK3BG1M';
const MAX_LEVEL = 243; // cm
let levelChart, flowChart;
let lastUpdateTime = null;

async function fetchData(){
  try{
    const r = await fetch(CHANNEL_URL);
    const j = await r.json();
    const feeds = j.feeds;
    if(!feeds || feeds.length===0) return;

    const latest = feeds[feeds.length-1];
    lastUpdateTime = new Date(latest.created_at);

    document.getElementById('signalStrength').textContent = latest.field1 || "N/A";

    const level = parseFloat(latest.field2);
    const flow  = parseFloat(latest.field3);

    const levelEl = document.getElementById('levelValue');
    const flowEl  = document.getElementById('flowValue');
    const fillEl  = document.getElementById('progressFill');

    levelEl.textContent = isNaN(level) ? 'N/A' : level.toFixed(1);
    flowEl.textContent  = isNaN(flow)  ? 'N/A' : flow.toFixed(2);

    // progress bar percent
    if(!isNaN(level)){
      const pct = Math.max(0, Math.min(100, (level / MAX_LEVEL) * 100));
      fillEl.style.width = pct + '%';

      // barva podle procent: zelen√° (>=50%), oran≈æov√° (20-50), ƒçerven√° (<20)
      if(pct >= 50){
        fillEl.style.background = 'linear-gradient(90deg,#22c55e,#16a34a)'; // green
      } else if (pct >= 20){
        fillEl.style.background = 'linear-gradient(90deg,#f59e0b,#fb923c)'; // orange
      } else {
        fillEl.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)'; // red
      }

      // zv√Ωraznit ƒç√≠slo pokud n√≠zk√° hladina
      if(level < 100){ levelEl.classList.add('alert'); } else { levelEl.classList.remove('alert'); }
    }

    if(!isNaN(flow)){
      if(flow < 1) flowEl.classList.add('alert'); else flowEl.classList.remove('alert');
    }

    // p≈ôiprav data pro grafy
    const labels = feeds.map(f => new Date(f.created_at).toLocaleString());
    const levelData = feeds.map(f => parseFloat(f.field2) || 0);
    const flowData  = feeds.map(f => parseFloat(f.field3) || 0);

    // vytvo≈ôen√≠ / aktualizace graf≈Ø
    const lvlCtx = document.getElementById('levelChart').getContext('2d');
    const flwCtx = document.getElementById('flowChart').getContext('2d');

    if(!levelChart){
      levelChart = new Chart(lvlCtx, {
        type:'line',
        data:{ labels, datasets:[{
          label:'Hladina (cm)',
          data: levelData,
          borderColor:'#0078d7',
          backgroundColor:'rgba(0,120,215,0.12)',
          fill:true,
          tension:0.3,
          pointRadius:3
        }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true}} }
      });
    } else {
      levelChart.data.labels = labels;
      levelChart.data.datasets[0].data = levelData;
      levelChart.update();
    }

    if(!flowChart){
      flowChart = new Chart(flwCtx, {
        type:'line',
        data:{ labels, datasets:[{
          label:'Pr≈Øtok (L/min)',
          data: flowData,
          borderColor:'#16a34a',
          backgroundColor:'rgba(34,139,34,0.12)',
          fill:true,
          tension:0.3,
          pointRadius:3
        }]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true}} }
      });
    } else {
      flowChart.data.labels = labels;
      flowChart.data.datasets[0].data = flowData;
      flowChart.update();
    }

    updateLastUpdateDisplay();
  } catch(e){
    console.error('Chyba naƒç√≠t√°n√≠:', e);
  }
}

function updateLastUpdateDisplay(){
  const el = document.getElementById('lastUpdate');
  if(!lastUpdateTime) { el.innerHTML = 'Aktualizov√°no: <span class="mins">‚Äì</span>'; return; }

  const now = new Date();
  const diffMin = Math.floor((now - lastUpdateTime) / 60000);
  const text = diffMin === 0 ? 'Aktualizov√°no pr√°vƒõ teƒè' : `Aktualizov√°no p≈ôed <span class="mins">${diffMin}</span> minutami`;
  el.innerHTML = text;

  // pokud star≈°√≠ ne≈æ 120 minut - nastav√≠me t≈ô√≠du stale, kter√° zmƒõn√≠ barvu/tuƒçnost
  if(diffMin > 120){
    el.classList.add('stale');
  } else {
    el.classList.remove('stale');
  }
}

/* prvn√≠ naƒçten√≠ + intervaly */
fetchData();
setInterval(fetchData, 30000);           // aktualizovat data ka≈æd√Ωch 30s
setInterval(updateLastUpdateDisplay, 10000); // obnovit text 'p≈ôed X minutami' ka≈æd√Ωch 10s
</script>
</body>
</html>
